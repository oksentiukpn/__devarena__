events {
    worker_connections 1024;
}

http {
    # 1. Приховуємо версію Nginx для безпеки
    server_tokens off;

    # 2. Визначаємо, чи прийшов запит від Cloudflare за реальною IP-адресою підключення
    # Використовуємо $realip_remote_addr, бо $remote_addr буде перезаписано нижче
    geo $realip_remote_addr $is_cloudflare {
        default 0;
        172.16.0.0/12 1;
        # IPv4 Cloudflare
        173.245.48.0/20 1;
        103.21.244.0/22 1;
        103.22.200.0/22 1;
        103.31.4.0/22 1;
        141.101.64.0/18 1;
        108.162.192.0/18 1;
        190.93.240.0/20 1;
        188.114.96.0/20 1;
        197.234.240.0/22 1;
        198.41.128.0/17 1;
        162.158.0.0/15 1;
        104.16.0.0/13 1;
        104.24.0.0/14 1;
        172.64.0.0/13 1;
        131.0.72.0/22 1;
        # IPv6 Cloudflare
        2400:cb00::/32 1;
        2606:4700::/32 1;
        2803:f800::/32 1;
        2405:b500::/32 1;
        2405:8100::/32 1;
        2a06:98c0::/29 1;
        2c0f:f248::/32 1;
    }

    # 3. Довіряємо Cloudflare та відновлюємо реальну IP-адресу користувача
    # Це КРИТИЧНО ВАЖЛИВО для того, щоб rate-limiting працював для користувачів, а не для Cloudflare
    set_real_ip_from 173.245.48.0/20;
    set_real_ip_from 103.21.244.0/22;
    set_real_ip_from 103.22.200.0/22;
    set_real_ip_from 103.31.4.0/22;
    set_real_ip_from 141.101.64.0/18;
    set_real_ip_from 108.162.192.0/18;
    set_real_ip_from 190.93.240.0/20;
    set_real_ip_from 188.114.96.0/20;
    set_real_ip_from 197.234.240.0/22;
    set_real_ip_from 198.41.128.0/17;
    set_real_ip_from 162.158.0.0/15;
    set_real_ip_from 104.16.0.0/13;
    set_real_ip_from 104.24.0.0/14;
    set_real_ip_from 172.64.0.0/13;
    set_real_ip_from 131.0.72.0/22;
    set_real_ip_from 2400:cb00::/32;
    set_real_ip_from 2606:4700::/32;
    set_real_ip_from 2803:f800::/32;
    set_real_ip_from 2405:b500::/32;
    set_real_ip_from 2405:8100::/32;
    set_real_ip_from 2a06:98c0::/29;
    set_real_ip_from 2c0f:f248::/32;
    real_ip_header CF-Connecting-IP;

    # 4. Ліміти тепер працюють коректно на базі реальної IP користувача
    limit_req_zone $binary_remote_addr zone=limit_zone:10m rate=50r/s;
    limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=1r/s;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # Redirect HTTP to HTTPS
    server {
        listen 80;
        server_name devarena.pp.ua;

        # Блокуємо прямі запити на 80 порт (не через Cloudflare)
        if ($is_cloudflare = 0) {
            return 403;
        }

        return 301 https://$host$request_uri;
    }

    server {
        listen 443 ssl;
        server_name devarena.pp.ua;

        # Блокуємо прямі запити на 443 порт (не через Cloudflare)
        if ($is_cloudflare = 0) {
            return 403;
        }

        ssl_certificate /etc/nginx/certs/cert.pem;
        ssl_certificate_key /etc/nginx/certs/key.pem;

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # --- Sensitive Routes (Login/Register) ---
        location ~ ^/(login|register) {
            limit_req zone=auth_limit burst=5 nodelay;

            proxy_pass http://web:5000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # --- General Traffic ---
        location / {
            limit_req zone=limit_zone burst=20 nodelay;

            proxy_pass http://web:5000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Block access to hidden files
        location ~ /\. {
            deny all;
            access_log off;
            log_not_found off;
        }
    }
}
