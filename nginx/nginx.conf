events {
    worker_connections 1024;
}

http {
    # 1. General Limit: Tracks IP addresses, limits to 50 requests/second
    limit_req_zone $binary_remote_addr zone=limit_zone:10m rate=50r/s;

    # 2. Auth Limit: Stricter limit for login/register (1 request/second) to stop bots
    limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=1r/s;

    server {
        # Listen on HTTPS port
        listen 443 ssl;
        server_name devarena.pp.ua;

        # Paths to certificates inside the container
        ssl_certificate /etc/nginx/certs/cert.pem;
        ssl_certificate_key /etc/nginx/certs/key.pem;

        # SSL Optimization (Standard Cloudflare settings)
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;

        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-XSS-Protection "1; mode=block";
        add_header X-Content-Type-Options "nosniff";
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

        # --- Sensitive Routes (Login/Register) ---
        # We put this ABOVE 'location /' so Nginx matches it first.
        # This applies the strict 'auth_limit' (1r/s) to login and register pages.
        location ~ ^/(login|register) {
            limit_req zone=auth_limit burst=5 nodelay;

            proxy_pass http://web:5000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # --- General Traffic ---
        location / {
            # Applies the general limit (10r/s) to everything else
            limit_req zone=limit_zone burst=20 nodelay;

            # Redirect requests to the Flask container
            # 'web' is the name of the Flask service in docker-compose
            proxy_pass http://web:5000;

            # Pass real headers so Flask knows the user's IP
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Block access to hidden files (like .env or .git)
        location ~ /\. {
            deny all;
            access_log off;
            log_not_found off;
        }
    }

    # (Optional) Redirect HTTP to HTTPS
    server {
        listen 80;
        server_name devarena.pp.ua;
        return 301 https://$host$request_uri;
    }
}
